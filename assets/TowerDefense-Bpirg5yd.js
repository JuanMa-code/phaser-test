import{r as f,j as y}from"./index-BsQ7NV5z.js";import{A as k,G as x,T as h,a as I}from"./HTMLText-CukwdB50.js";const b=12,W=8,t=48,m=[{x:0,y:3},{x:1,y:3},{x:2,y:3},{x:3,y:3},{x:4,y:3},{x:5,y:3},{x:6,y:3},{x:7,y:3},{x:8,y:3},{x:8,y:4},{x:9,y:4},{x:10,y:4},{x:11,y:4}],X=.02,$=3,_=60,F=.06,U=()=>{const T=f.useRef(null),[G,v]=f.useState(10),[A,L]=f.useState(1),[g,R]=f.useState(!1),[M,u]=f.useState(""),n=f.useRef({enemies:[],towers:[],shots:[],pendingEnemies:[],spawnTimer:0,currentGold:10,currentWave:1,damageTexts:[]}),E=[1668818,4431943,16498733,15022389,9315498,48340,16750592,7162945,13491257,2171169];f.useEffect(()=>{const a=new k({width:b*t,height:W*t,backgroundColor:2237226});T.current&&a.view instanceof Node&&T.current.appendChild(a.view);let w=!1;function z(){if(!w){for(let c=0;c<W;c++)for(let e=0;e<b;e++){const i=new x;i.lineStyle(1,4473924),i.beginFill(2237226),i.drawRect(0,0,t,t),i.endFill(),i.x=e*t,i.y=c*t,i.name="static",a.stage.addChild(i)}m.forEach((c,e)=>{const i=new x;i.beginFill(11184810),i.drawRect(0,0,t,t),i.endFill(),i.x=c.x*t,i.y=c.y*t,i.name="static",a.stage.addChild(i)}),w=!0}}function N(){for(let c=a.stage.children.length-1;c>=0;c--){const e=a.stage.children[c];e.name!=="static"&&a.stage.removeChild(e)}}function C(){N(),n.current.towers.forEach(r=>{const s=E[Math.min(r.level-1,E.length-1)],o=new x;o.beginFill(s),o.drawCircle(t/2,t/2,t/2-6),o.endFill(),o.lineStyle(2,16777215),o.drawCircle(t/2,t/2,(t/2-6)*(1+r.level*.2)),o.x=r.x*t,o.y=r.y*t,o.name="tower",a.stage.addChild(o);const l=new h(r.level.toString(),{fill:16777215,fontSize:14,fontWeight:"bold",align:"center"});l.anchor.set(.5),l.x=r.x*t+t/2,l.y=r.y*t+t/2,l.name="tower-level",a.stage.addChild(l)}),n.current.enemies.forEach((r,s)=>{if(!r.alive)return;const o=m[Math.floor(r.pos)];if(!o)return;const l=new x;l.beginFill(16724787),l.drawCircle(t/2,t/2,t/2-8),l.endFill(),l.x=o.x*t,l.y=o.y*t,l.name="enemy",a.stage.addChild(l);const d=new x;d.beginFill(65280);const P=Math.max(0,r.hp);d.drawRect(0,0,(t-8)*(P/r.maxHp),6),d.endFill(),d.x=o.x*t+4,d.y=o.y*t+t-12,d.name="hp",a.stage.addChild(d);const p=new h(Math.ceil(P).toString(),{fill:16777215,fontSize:12,fontWeight:"bold",align:"center"});p.anchor.set(.5),p.x=o.x*t+t/2,p.y=o.y*t+t/2,p.name="enemy-hp",a.stage.addChild(p)}),n.current.shots.forEach(r=>{const s=E[Math.min(r.towerLevel-1,E.length-1)],o=new x;o.beginFill(s),o.drawCircle(0,0,7),o.endFill(),o.x=r.x,o.y=r.y,o.name="shot",a.stage.addChild(o)});const c=new I({fill:16777215,fontSize:20,fontWeight:"bold"}),e=new h(`Oro: ${n.current.currentGold}`,c);e.x=12,e.y=8,e.name="ui",a.stage.addChild(e);const i=new h(`Oleada: ${n.current.currentWave}`,c);if(i.x=12,i.y=32,i.name="ui",a.stage.addChild(i),g){const r=new h("Haz clic en una celda junto al camino para poner torre (5 oro)",{fill:16773494,fontSize:16});r.x=12,r.y=56,r.name="ui",a.stage.addChild(r)}if(M){const r=new h(M,{fill:16724787,fontSize:18});r.x=12,r.y=80,r.name="ui",a.stage.addChild(r)}n.current.damageTexts.forEach(r=>{const s=new h(`-${r.damage}`,{fill:16776960,fontSize:14,fontWeight:"bold",align:"center",stroke:0,strokeThickness:2});s.anchor.set(.5),s.x=r.x+Math.random()*20-10,s.y=r.y-(120-r.timer)*.8,s.alpha=Math.min(1,r.timer/20),s.name="damage-text",a.stage.addChild(s)})}z(),C();let S;function j(){if(n.current.pendingEnemies.length>0&&(n.current.spawnTimer--,n.current.spawnTimer<=0)){const e=n.current.pendingEnemies.shift();e&&n.current.enemies.push(e),n.current.spawnTimer=40}n.current.enemies.forEach(e=>{if(!e.alive)return;let i=e.pos+X;if(i>=m.length){e.alive=!1,u("¡Un enemigo ha llegado al final!");return}e.pos=i}),n.current.towers.forEach((e,i)=>{if(e.cooldown=Math.max(0,e.cooldown-1),e.cooldown===0){const r=n.current.enemies.findIndex(s=>s.alive&&Y(e.x,e.y,m[Math.floor(s.pos)].x,m[Math.floor(s.pos)].y)<=$);if(r!==-1){const s=n.current.enemies[r],o=m[Math.floor(s.pos)].x*t+t/2,l=m[Math.floor(s.pos)].y*t+t/2;n.current.shots.push({x:e.x*t+t/2,y:e.y*t+t/2,tx:o,ty:l,progress:0,damage:Math.pow(2,e.level),target:r,towerLevel:e.level}),e.cooldown=_}}}),n.current.shots=n.current.shots.filter(e=>{e.progress+=F;const i=e.tx-e.x,r=e.ty-e.y;if(e.x+=i*F,e.y+=r*F,Math.abs(i)<8&&Math.abs(r)<8){const s=n.current.enemies[e.target];if(s&&s.alive){s.hp-=e.damage;const o=m[Math.floor(s.pos)];o&&(n.current.damageTexts.push({x:o.x*t+t/2,y:o.y*t+t/2-20,damage:e.damage,timer:120}),console.log(`Daño flotante creado: ${e.damage} en posición de enemigo (${o.x*t+t/2}, ${o.y*t+t/2-20})`))}return!1}return!0});let c=0;n.current.enemies.forEach(e=>{e.hp<=0&&e.alive&&(c+=n.current.currentWave-1,e.alive=!1)}),c>0&&(n.current.currentGold+=c,v(n.current.currentGold)),n.current.damageTexts=n.current.damageTexts.filter(e=>(e.timer--,e.timer>0)),C(),S=requestAnimationFrame(j)}S=requestAnimationFrame(j);function Y(c,e,i,r){return Math.sqrt((c-i)**2+(e-r)**2)}function O(c){if(!g||!(a.view instanceof HTMLCanvasElement))return;const e=a.view.getBoundingClientRect(),i=c.clientX-e.left,r=c.clientY-e.top,s=Math.floor(i/t),o=Math.floor(r/t);if(!m.some(d=>Math.abs(d.x-s)+Math.abs(d.y-o)===1)){u("Solo puedes poner torres junto al camino");return}if(n.current.towers.some(d=>d.x===s&&d.y===o)){u("Ya hay una torre ahí");return}if(n.current.currentGold<5){u("No tienes suficiente oro");return}n.current.towers.push({x:s,y:o,level:1,cooldown:0}),n.current.currentGold-=5,v(n.current.currentGold),u(""),R(!1),C()}function H(c){if(g||!(a.view instanceof HTMLCanvasElement))return;const e=a.view.getBoundingClientRect(),i=c.clientX-e.left,r=c.clientY-e.top,s=Math.floor(i/t),o=Math.floor(r/t),l=n.current.towers.findIndex(d=>d.x===s&&d.y===o);if(l!==-1){const d=Math.pow(2,n.current.towers[l].level)*5;if(n.current.currentGold<d){u("No tienes suficiente oro para mejorar");return}n.current.towers[l].level+=1,n.current.currentGold-=d,v(n.current.currentGold),u("Torre mejorada"),C()}}return a.view instanceof HTMLCanvasElement&&(a.view.addEventListener("pointerdown",O),a.view.addEventListener("pointerup",H)),()=>{a.view instanceof HTMLCanvasElement&&(a.view.removeEventListener("pointerdown",O),a.view.removeEventListener("pointerup",H)),cancelAnimationFrame(S),a.destroy(!0,{children:!0})}},[g,M]);function D(){const a=[];for(let w=0;w<n.current.currentWave*2;w++)a.push({pos:0,hp:n.current.currentWave+1,maxHp:n.current.currentWave+1,alive:!0});n.current.pendingEnemies=a,n.current.spawnTimer=0,n.current.enemies=[],n.current.currentWave+=1,L(n.current.currentWave),u("")}return f.useEffect(()=>{v(n.current.currentGold),L(n.current.currentWave)},[]),f.useEffect(()=>{n.current.enemies.length>0&&n.current.enemies.every(a=>!a.alive)&&u("¡Oleada completada!")},[G,A]),y.jsxs("div",{children:[y.jsx("div",{ref:T,style:{width:b*t,height:W*t,margin:"auto"}}),y.jsxs("div",{style:{textAlign:"center",marginTop:16},children:[y.jsx("button",{onClick:()=>R(!0),disabled:g||G<5,style:{marginRight:8},children:g?"Haz clic en el mapa...":"Colocar torre (5 oro)"}),y.jsx("button",{onClick:D,disabled:n.current.enemies.some(a=>a.alive),children:"Iniciar oleada"})]})]})};export{U as default};
