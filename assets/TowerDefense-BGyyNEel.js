import{r as m,j as v}from"./index-CJB0W8ET.js";import{A as X,G as w,T as _,a as E}from"./HTMLText-Cx_dGUxy.js";const b=12,F=8,n=48,h=[{x:0,y:3},{x:1,y:3},{x:2,y:3},{x:3,y:3},{x:4,y:3},{x:5,y:3},{x:6,y:3},{x:7,y:3},{x:8,y:3},{x:8,y:4},{x:9,y:4},{x:10,y:4},{x:11,y:4}],z=.02,G=3,k=60,R=.06,U=()=>{const C=m.useRef(null),[g,M]=m.useState(10),[f,D]=m.useState(1),[x,L]=m.useState(!1),[T,u]=m.useState(""),i=m.useRef({enemies:[],towers:[],shots:[],pendingEnemies:[],spawnTimer:0}),j=[1668818,4431943,16498733,15022389,9315498,48340,16750592,7162945,13491257,2171169];m.useEffect(()=>{const o=new X({width:b*n,height:F*n,backgroundColor:2237226});C.current&&o.view instanceof Node&&C.current.appendChild(o.view);let p=!1;function Y(){if(p)return;for(let r=0;r<F;r++)for(let a=0;a<b;a++){const e=new w;e.lineStyle(1,4473924),e.beginFill(2237226),e.drawRect(0,0,n,n),e.endFill(),e.x=a*n,e.y=r*n,e.name="static",o.stage.addChild(e)}h.forEach((r,a)=>{const e=new w;e.beginFill(11184810),e.drawRect(0,0,n,n),e.endFill(),e.x=r.x*n,e.y=r.y*n,e.name="static",o.stage.addChild(e)});const t=[1668818,4431943,16498733,15022389,9315498,48340,16750592,7162945,13491257,2171169];i.current.towers.forEach(r=>{const a=t[Math.min(r.level-1,t.length-1)],e=new w;e.beginFill(a),e.drawCircle(n/2,n/2,n/2-6),e.endFill(),e.lineStyle(2,16777215),e.drawCircle(n/2,n/2,(n/2-6)*(1+r.level*.2)),e.x=r.x*n,e.y=r.y*n,e.name="tower",o.stage.addChild(e)}),p=!0}function W(){for(let t=o.stage.children.length-1;t>=0;t--){const r=o.stage.children[t];r.name!=="static"&&r.name!=="tower"&&o.stage.removeChild(r)}}function O(){W(),i.current.enemies.forEach((e,d)=>{if(!e.alive)return;const l=h[Math.floor(e.pos)];if(!l)return;const c=new w;c.beginFill(16724787),c.drawCircle(n/2,n/2,n/2-8),c.endFill(),c.x=l.x*n,c.y=l.y*n,c.name="enemy",o.stage.addChild(c);const s=new w;s.beginFill(65280);const y=Math.max(0,e.hp);s.drawRect(0,0,(n-8)*(y/e.maxHp),6),s.endFill(),s.x=l.x*n+4,s.y=l.y*n+n-12,s.name="hp",o.stage.addChild(s)}),i.current.shots.forEach(e=>{const d=i.current.towers.find((s,y)=>y===e.target);let l=16776960;d&&(l=j[Math.min(d.level-1,j.length-1)]);const c=new w;c.beginFill(l),c.drawCircle(0,0,7),c.endFill(),c.x=e.x,c.y=e.y,c.name="shot",o.stage.addChild(c)});const t=new _({fill:16777215,fontSize:20,fontWeight:"bold"}),r=new E(`Oro: ${g}`,t);r.x=12,r.y=8,r.name="ui",o.stage.addChild(r);const a=new E(`Oleada: ${f}`,t);if(a.x=12,a.y=32,a.name="ui",o.stage.addChild(a),x){const e=new E("Haz clic en una celda junto al camino para poner torre (5 oro)",{fill:16773494,fontSize:16});e.x=12,e.y=56,e.name="ui",o.stage.addChild(e)}if(T){const e=new E(T,{fill:16724787,fontSize:18});e.x=12,e.y=80,e.name="ui",o.stage.addChild(e)}}Y(),O();let S;function H(){if(i.current.pendingEnemies.length>0&&(i.current.spawnTimer--,i.current.spawnTimer<=0)){const t=i.current.pendingEnemies.shift();t&&i.current.enemies.push(t),i.current.spawnTimer=40}i.current.enemies.forEach(t=>{if(!t.alive)return;let r=t.pos+z;if(r>=h.length){t.alive=!1,u("¡Un enemigo ha llegado al final!");return}t.pos=r}),i.current.towers.forEach((t,r)=>{if(t.cooldown=Math.max(0,t.cooldown-1),t.cooldown===0){const a=i.current.enemies.findIndex(e=>e.alive&&I(t.x,t.y,h[Math.floor(e.pos)].x,h[Math.floor(e.pos)].y)<=G);if(a!==-1){const e=i.current.enemies[a],d=h[Math.floor(e.pos)].x*n+n/2,l=h[Math.floor(e.pos)].y*n+n/2;i.current.shots.push({x:t.x*n+n/2,y:t.y*n+n/2,tx:d,ty:l,progress:0,damage:Math.pow(2,t.level),target:a}),t.cooldown=k}}}),i.current.shots=i.current.shots.filter(t=>{t.progress+=R;const r=t.tx-t.x,a=t.ty-t.y;if(t.x+=r*R,t.y+=a*R,Math.abs(r)<8&&Math.abs(a)<8){const e=i.current.enemies[t.target];return e&&e.alive&&(e.hp-=t.damage),!1}return!0}),i.current.enemies.forEach(t=>{t.hp<=0&&t.alive&&(M(r=>r+f),t.alive=!1)}),O(),S=requestAnimationFrame(H)}S=requestAnimationFrame(H);function I(t,r,a,e){return Math.sqrt((t-a)**2+(r-e)**2)}function P(t){if(!x||!(o.view instanceof HTMLCanvasElement))return;const r=o.view.getBoundingClientRect(),a=t.clientX-r.left,e=t.clientY-r.top,d=Math.floor(a/n),l=Math.floor(e/n);if(!h.some(s=>Math.abs(s.x-d)+Math.abs(s.y-l)===1)){u("Solo puedes poner torres junto al camino");return}if(i.current.towers.some(s=>s.x===d&&s.y===l)){u("Ya hay una torre ahí");return}if(g<5){u("No tienes suficiente oro");return}i.current.towers.push({x:d,y:l,level:1,cooldown:0}),M(s=>s-5),u(""),L(!1)}function A(t){if(!(o.view instanceof HTMLCanvasElement))return;const r=o.view.getBoundingClientRect(),a=t.clientX-r.left,e=t.clientY-r.top,d=Math.floor(a/n),l=Math.floor(e/n),c=i.current.towers.findIndex(s=>s.x===d&&s.y===l);if(c!==-1){const s=Math.pow(2,i.current.towers[c].level)*5;if(g<s){u("No tienes suficiente oro para mejorar");return}i.current.towers[c].level+=1,M(y=>y-s),u("Torre mejorada")}}return o.view instanceof HTMLCanvasElement&&(o.view.addEventListener("pointerdown",P),o.view.addEventListener("pointerup",A)),()=>{o.view instanceof HTMLCanvasElement&&(o.view.removeEventListener("pointerdown",P),o.view.removeEventListener("pointerup",A)),cancelAnimationFrame(S),o.destroy(!0,{children:!0})}},[x,g,f,T]);function N(){const o=[];for(let p=0;p<f*2;p++)o.push({pos:0,hp:f+1,maxHp:f+1,alive:!0});i.current.pendingEnemies=o,i.current.spawnTimer=0,i.current.enemies=[],D(f+1),u("")}return m.useEffect(()=>{i.current.enemies.length>0&&i.current.enemies.every(o=>!o.alive)&&u("¡Oleada completada!")},[g,f]),v.jsxs("div",{children:[v.jsx("div",{ref:C,style:{width:b*n,height:F*n,margin:"auto"}}),v.jsxs("div",{style:{textAlign:"center",marginTop:16},children:[v.jsx("button",{onClick:()=>L(!0),disabled:x||g<5,style:{marginRight:8},children:x?"Haz clic en el mapa...":"Colocar torre (5 oro)"}),v.jsx("button",{onClick:N,disabled:i.current.enemies.some(o=>o.alive),children:"Iniciar oleada"})]})]})};export{U as default};
